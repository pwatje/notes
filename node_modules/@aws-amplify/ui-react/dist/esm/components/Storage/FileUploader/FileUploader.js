import{__rest as e}from"tslib";import{jsxs as i,Fragment as t,jsx as r}from"react/jsx-runtime";import s,{useState as o,useEffect as l,useCallback as a,useMemo as n}from"react";import{Storage as p}from"@aws-amplify/storage";import{translate as m,uploadFile as c,isValidExtension as d}from"@aws-amplify/ui";import{Logger as u}from"aws-amplify";import"../../../primitives/Alert/Alert.js";import"../../../primitives/Autocomplete/Autocomplete.js";import"../../../primitives/Badge/Badge.js";import{Button as v}from"../../../primitives/Button/Button.js";import"../../../primitives/ButtonGroup/ButtonGroup.js";import"../../../primitives/Card/Card.js";import"../../../primitives/CheckboxField/CheckboxField.js";import"../../../primitives/Collection/Collection.js";import"../../../primitives/Divider/Divider.js";import"../../../primitives/Expander/Expander.js";import"../../../primitives/Expander/ExpanderItem.js";import"../../../primitives/FieldGroupIcon/FieldGroupIcon.js";import"../../../primitives/FieldGroupIcon/FieldGroupIconButton.js";import"../../../primitives/Flex/Flex.js";import"../../../primitives/Grid/Grid.js";import"../../../primitives/Heading/Heading.js";import"../../../primitives/HighlightMatch/HighlightMatch.js";import"../../../primitives/Icon/Icon.js";import"../../../primitives/Image/Image.js";import"../../../primitives/Link/Link.js";import"../../../primitives/Loader/Loader.js";import"../../../primitives/Menu/Menu.js";import"../../../primitives/Menu/MenuButton.js";import"../../../primitives/Menu/MenuItem.js";import"../../../primitives/Pagination/Pagination.js";import"../../../primitives/PasswordField/PasswordField.js";import"../../../primitives/PhoneNumberField/PhoneNumberField.js";import"../../../primitives/Placeholder/Placeholder.js";import"../../../primitives/Radio/Radio.js";import"../../../primitives/RadioGroupField/RadioGroupField.js";import"../../../primitives/Rating/Rating.js";import"../../../primitives/ScrollView/ScrollView.js";import"../../../primitives/SearchField/SearchField.js";import"../../../primitives/SelectField/SelectField.js";import"../../../primitives/SliderField/SliderField.js";import"../../../primitives/StepperField/StepperField.js";import"../../../primitives/SwitchField/SwitchField.js";import"../../../primitives/Table/Table.js";import"../../../primitives/Table/TableBody.js";import"../../../primitives/Table/TableCell.js";import"../../../primitives/Table/TableFoot.js";import"../../../primitives/Table/TableHead.js";import"../../../primitives/Table/TableRow.js";import"../../../primitives/Tabs/Tabs.js";import"../../../primitives/Text/Text.js";import"../../../primitives/TextAreaField/TextAreaField.js";import"../../../primitives/TextField/TextField.js";import"../../../primitives/ToggleButton/ToggleButton.js";import"../../../primitives/ToggleButtonGroup/ToggleButtonGroup.js";import"../../../primitives/View/View.js";import{VisuallyHidden as g}from"../../../primitives/VisuallyHidden/VisuallyHidden.js";import{ComponentClassNames as j}from"../../../primitives/shared/constants.js";import f from"./hooks/useFileUploader/useFileUploader.js";import{UploadPreviewer as b}from"./UploadPreviewer/index.js";import{UploadDropZone as h}from"./UploadDropZone/index.js";import{UploadTracker as F}from"./UploadTracker/index.js";const S=e=>"function"==typeof(null==e?void 0:e.resume),T=new u("AmplifyUI:Storage");function w(u){var{acceptedFileTypes:w,shouldAutoProceed:x=!1,isPreviewerVisible:O,maxFiles:P,maxSize:k,hasMultipleFiles:y=!0,onError:C,onSuccess:I,showImages:M=!0,accessLevel:B,variation:E="drop",isResumable:R=!1}=u,G=e(u,["acceptedFileTypes","shouldAutoProceed","isPreviewerVisible","maxFiles","maxSize","hasMultipleFiles","onError","onSuccess","showImages","accessLevel","variation","isResumable"]);w&&B||T.warn("FileUploader requires accessLevel and acceptedFileTypes props");const[A,L]=o(!1),[D,U]=o(!1),V=f({maxSize:k,acceptedFileTypes:w,hasMultipleFiles:y,isLoading:A,setAutoLoad:U}),{addTargetFiles:H,fileStatuses:Z,inDropZone:z,setFileStatuses:N,setShowPreviewer:q,showPreviewer:W}=V,J=e(V,["addTargetFiles","fileStatuses","inDropZone","setFileStatuses","setShowPreviewer","showPreviewer"]),K=Math.floor(Z.reduce(((e,i)=>{var t;return e+(null!==(t=null==i?void 0:i.percentage)&&void 0!==t?t:0)}),0)/Z.length),Q=0!==Z.length&&Z.every((e=>100===(null==e?void 0:e.percentage))),X=Z.filter((e=>100!==e.percentage)).length>P;l((()=>{100===Math.floor(K)&&L(!1)}),[K]),l((()=>{q(O)}),[q,O]);const Y=a((e=>i=>{N((t=>{const r=Object.assign({},t[e]),s=Math.floor(i.loaded/i.total*100),o=100!==s?"loading":"success",l=Object.assign(Object.assign({},r),{percentage:s,fileState:o});return t[e]=l,[...t]}))}),[N]),$=a((e=>i=>{N((t=>{const r=Object.assign({},t[e]),s=Object.assign(Object.assign({},r),{fileState:"error",fileErrors:m(i.toString())});return t[e]=s,[...t]})),L(!1),"function"==typeof C&&C(i)}),[C,N]),_=a((e=>function(){const i=Z[e];S(i.uploadTask)&&i.uploadTask.pause();const t=[...Z];t[e]=Object.assign(Object.assign({},i),{fileState:"paused"}),N(t)}),[Z,N]),ee=a((e=>function(){const i=Z[e];S(i.uploadTask)&&i.uploadTask.resume();const t=[...Z];t[e]=Object.assign(Object.assign({},i),{fileState:"resume"}),N(t)}),[Z,N]),ie=a((()=>{L(!0);const e=[];Z.forEach(((i,t)=>{if("success"===(null==i?void 0:i.fileState))return;const r=c(Object.assign({file:i.file,fileName:i.name,level:B,isResumable:R,progressCallback:Y(t),errorCallback:$(t),completeCallback:I},G));S(r)&&R&&e.push(r)})),N((i=>i.map(((i,t)=>{var r,s;return Object.assign(Object.assign({},i),{uploadTask:null==e?void 0:e[t],fileState:null!==(r=i.fileState)&&void 0!==r?r:"loading",percentage:null!==(s=i.percentage)&&void 0!==s?s:0})}))))}),[$,Z,R,I,Y,G,N,B]),te=a((e=>{if(!e.target.files||0===e.target.files.length)return;const{files:i}=e.target;H([...i])>0&&(q(!0),U(!0))}),[H,q]),re=a((()=>{q(!1),N([])}),[N,q]),se=a((e=>()=>{const{fileState:i,uploadTask:t}=Z[e];"loading"===i&&S(t)&&(p.cancel(t),L(!1));const r=Z.filter(((i,t)=>t!==e));N(r)}),[Z,N]),oe=a((e=>i=>{if(0===i.trim().length)return;const t=[...Z],r=Z[e],s=d(i,r.file.name);t[e]=Object.assign(Object.assign({},r),{name:i,fileState:s?null:"error",fileErrors:s?void 0:m("Extension not allowed")}),N(t)}),[Z,N]),le=a(((e,i)=>{N((t=>{const r=[...t],s=r[e],o=d(s.name,s.file.name)?null:"error",l=null===i?o:i;return r[e]=Object.assign(Object.assign({},s),{fileState:l}),r}))}),[N]),ae=a((e=>()=>{le(e,null)}),[le]),ne=a((e=>i=>{le(e,"editing")}),[le]);l((()=>{x&&D&&!X&&(ie(),U(!1))}),[x,ie,D,X]);const pe=s.useRef(),me=null==w?void 0:w.join(),ce=n((()=>i(t,{children:[r(v,Object.assign({className:j.FileUploaderDropZoneButton,isDisabled:A,onClick:()=>{pe.current.click(),pe.current.value=null},size:"small"},{children:m("Browse files")})),r(g,{children:r("input",{type:"file",tabIndex:-1,ref:pe,onChange:te,multiple:y,accept:me})})]})),[A,te,y,me]);return W?r(b,Object.assign({dropZone:r(h,Object.assign({},J,{inDropZone:z},{children:ce})),fileStatuses:Z,isLoading:A,isSuccessful:Q,hasMaxFilesError:X,onClear:re,onFileClick:ie,aggregatePercentage:K},{children:null==Z?void 0:Z.map(((e,i)=>{var t;return r(F,{errorMessage:null==e?void 0:e.fileErrors,file:e.file,fileState:null==e?void 0:e.fileState,hasImage:null===(t=e.file)||void 0===t?void 0:t.type.startsWith("image/"),showImage:M,name:e.name,onCancel:se(i),onCancelEdit:ae(i),onPause:_(i),onResume:ee(i),onSaveEdit:oe(i),onStartEdit:ne(i),percentage:e.percentage,isResumable:R},i)}))})):"button"===E?ce:r(h,Object.assign({},J,{inDropZone:z},{children:ce}))}export{w as FileUploader};
