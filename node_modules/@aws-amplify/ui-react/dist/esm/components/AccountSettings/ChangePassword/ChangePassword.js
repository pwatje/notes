import{__awaiter as i}from"tslib";import{jsx as e,jsxs as r}from"react/jsx-runtime";import s from"react";import t from"lodash/isEqual";import{Logger as o}from"aws-amplify";import{getDefaultPasswordValidators as a,runFieldValidators as m,getDefaultConfirmPasswordValidators as n,translate as l,changePassword as p}from"@aws-amplify/ui";import{useAuth as d}from"../../../hooks/useAuth.js";import"@aws-amplify/datastore";import"@aws-amplify/storage";import"classnames";import"../../../primitives/shared/constants.js";import{View as u}from"../../../primitives/View/View.js";import"../../../primitives/Alert/Alert.js";import"../../../primitives/Autocomplete/Autocomplete.js";import"../../../primitives/Badge/Badge.js";import"../../../primitives/Button/Button.js";import"../../../primitives/ButtonGroup/ButtonGroup.js";import"../../../primitives/Card/Card.js";import"../../../primitives/CheckboxField/CheckboxField.js";import"../../../primitives/Collection/Collection.js";import"../../../primitives/Divider/Divider.js";import"../../../primitives/Expander/Expander.js";import"../../../primitives/Expander/ExpanderItem.js";import"../../../primitives/FieldGroupIcon/FieldGroupIcon.js";import"../../../primitives/FieldGroupIcon/FieldGroupIconButton.js";import{Flex as c}from"../../../primitives/Flex/Flex.js";import"../../../primitives/Grid/Grid.js";import"../../../primitives/Heading/Heading.js";import"../../../primitives/HighlightMatch/HighlightMatch.js";import"../../../primitives/Icon/Icon.js";import"../../../primitives/Image/Image.js";import"../../../primitives/Link/Link.js";import"../../../primitives/Loader/Loader.js";import"../../../primitives/Menu/Menu.js";import"../../../primitives/Menu/MenuButton.js";import"../../../primitives/Menu/MenuItem.js";import"../../../primitives/Pagination/Pagination.js";import"../../../primitives/PasswordField/PasswordField.js";import"../../../primitives/PhoneNumberField/PhoneNumberField.js";import"../../../primitives/Placeholder/Placeholder.js";import"../../../primitives/Radio/Radio.js";import"../../../primitives/RadioGroupField/RadioGroupField.js";import"../../../primitives/Rating/Rating.js";import"../../../primitives/ScrollView/ScrollView.js";import"../../../primitives/SearchField/SearchField.js";import"../../../primitives/SelectField/SelectField.js";import"../../../primitives/SliderField/SliderField.js";import"../../../primitives/StepperField/StepperField.js";import"../../../primitives/SwitchField/SwitchField.js";import"../../../primitives/Table/Table.js";import"../../../primitives/Table/TableBody.js";import"../../../primitives/Table/TableCell.js";import"../../../primitives/Table/TableFoot.js";import"../../../primitives/Table/TableHead.js";import"../../../primitives/Table/TableRow.js";import"../../../primitives/Tabs/Tabs.js";import"../../../primitives/Text/Text.js";import"../../../primitives/TextAreaField/TextAreaField.js";import"../../../primitives/TextField/TextField.js";import"../../../primitives/ToggleButton/ToggleButton.js";import"../../../primitives/ToggleButtonGroup/ToggleButtonGroup.js";import"../../../primitives/VisuallyHidden/VisuallyHidden.js";import{ComponentClassName as v}from"../constants.js";import w from"./defaults.js";const j=new o("ChangePassword");function g({onSuccess:o,onError:g,validators:P,components:f}){const[b,h]=s.useState(null),[F,T]=s.useState({}),[C,B]=s.useState({}),S=s.useRef([]),{user:x,isLoading:y}=d(),M=((i,e)=>{var r,s;const{currentPassword:t,newPassword:o,confirmPassword:a}=i;return!(t&&o&&a)||((null===(r=e.newPassword)||void 0===r?void 0:r.length)>0||(null===(s=e.confirmPassword)||void 0===s?void 0:s.length)>0)})(F,C),G=s.useMemo((()=>null!=P?P:a()),[P]),V=s.useCallback((({formValues:i,eventType:e})=>{const{newPassword:r}=i,s=S.current.includes("newPassword");return m({value:r,validators:G,eventType:e,hasBlurred:s})}),[G]),E=s.useCallback((({formValues:i,eventType:e})=>{const{newPassword:r,confirmPassword:s}=i,t=S.current.includes("confirmPassword"),o=n(r);return m({value:s,validators:o,eventType:e,hasBlurred:t})}),[]),R=s.useCallback((i=>{const e={newPassword:V(i),confirmPassword:E(i)};t(C,e)||B(e)}),[E,V,C]),I=l("Current Password"),k=l("New Password"),A=l("Confirm Password"),H=l("Update password"),{CurrentPasswordField:N,NewPasswordField:O,ConfirmPasswordField:D,SubmitButton:q,ErrorMessage:L}=s.useMemo((()=>Object.assign(Object.assign({},w),null!=f?f:{})),[f]),U=i=>{i.preventDefault();const{name:e,value:r}=i.target,s=Object.assign(Object.assign({},F),{[e]:r});R({formValues:s,eventType:"change"}),T(s)},z=i=>{i.preventDefault();const{name:e}=i.target;if(!S.current.includes(e)){const i=[...S.current,e];S.current=i,R({formValues:F,eventType:"blur"})}};return y?null:x?e(u,Object.assign({as:"form",className:v.ChangePassword,onSubmit:e=>i(this,void 0,void 0,(function*(){e.preventDefault();const{currentPassword:i,newPassword:r}=F;b&&h(null);try{yield p({user:x,currentPassword:i,newPassword:r}),null==o||o()}catch(i){const e=i;e.message&&h(e.message),null==g||g(e)}}))},{children:r(c,Object.assign({direction:"column"},{children:[e(N,{autoComplete:"current-password",isRequired:!0,label:I,name:"currentPassword",onBlur:z,onChange:U}),e(O,{autoComplete:"new-password",fieldValidationErrors:null==C?void 0:C.newPassword,isRequired:!0,label:k,name:"newPassword",onBlur:z,onChange:U}),e(D,{autoComplete:"new-password",fieldValidationErrors:null==C?void 0:C.confirmPassword,isRequired:!0,label:A,name:"confirmPassword",onBlur:z,onChange:U}),e(q,Object.assign({isDisabled:M,type:"submit"},{children:H})),b?e(L,{children:b}):null]}))})):(j.warn("<ChangePassword /> requires user to be authenticated."),null)}g.CurrentPasswordField=w.CurrentPasswordField,g.NewPasswordField=w.NewPasswordField,g.ConfirmPasswordField=w.ConfirmPasswordField,g.SubmitButton=w.SubmitButton,g.ErrorMessage=w.ErrorMessage;export{g as default};
